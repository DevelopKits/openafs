# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html
#
# Portions Copyright (c) 2006-2007 Sine Nomine Associates

srcdir=@srcdir@
include @TOP_OBJDIR@/src/config/Makefile.config
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@
HELPER_SPLINT=@HELPER_SPLINT@

CC=${MT_CC}
CFLAGS=${COMMON_CFLAGS} -I.. -DNINTERFACE ${MT_CFLAGS} -DRXDEBUG -DFSSYNC_BUILD_CLIENT

CCRULE=${CC} ${CFLAGS} -c $? -o $@

VICED=../viced
VLSERVER=../vlserver
LWP=../lwp
LIBACL=../libacl
UTIL=../util
DIR=../dir
VOL=../vol
FSINT=../fsint
VOLSER=../volser
RX=../rx

VOLSEROBJS= \
	dumpstuff.o \
	physio.o \
	volerr.o \
	volint.cs.o \
	volint.ss.o \
	volint.xdr.o \
	volmain.o \
	volprocs.o \
	voltrans.o \
	vscommon.o \
	$(NULL)

VLSERVEROBJS=#vldbint.cs.o vldbint.xdr.o

LWPOBJS= \
	lock.o \
	threadname.o \
	$(NULL)

LIBACLOBJS= \
	aclprocs.o \
	netprocs.o \
	$(NULL)

UTILOBJS= \
	assert.o \
	dirpath.o \
	fileutil.o \
	flipbase64.o \
	netutils.o \
	serverLog.o \
	softsig.o \
	uuid.o \
	volparse.o \
	$(NULL)

DIROBJS= \
	buffer.o \
	dir.o \
	salvage.o \
	$(NULL)

VOLOBJS= \
	clone.o \
	common.o \
	daemon_com.o \
	devname.o \
	fssync-client.o \
	ihandle.o \
	listinodes.o \
	namei_ops.o \
	nuke.o \
	partition.o \
	purge.o \
	salvsync-client.o \
	vnode.o \
	volume.o \
	vol_tracepoint_table.o \
	vutil.o \
	$(NULL)

FSINTOBJS=# afsaux.o afscbint.cs.o afsint.ss.o afsint.xdr.o

RXOBJS=rx_pthread.o

objects= \
	${VOLSEROBJS} \
	${VLSERVEROBJS} \
	${LWPOBJS} \
	${LIBACLOBJS} \
	${UTILOBJS} \
	${DIROBJS} \
	${VOLOBJS} \
	${FSINTOBJS} \
	${RXOBJS} \
	$(NULL)

LIBS= \
	${TOP_LIBDIR}/libafsauthent.a \
	${TOP_LIBDIR}/libafsrpc.a \
	${TOP_LIBDIR}/libosi-pthread-inst.a \
	${TOP_LIBDIR}/libsys.a \
	${TOP_LIBDIR}/util.a \
	$(NULL)


all: volserver

rx_pthread.o: ${RX}/rx_pthread.c
	${COMPILE} -DDPF_FSLOG
volmain.o: ${VOLSER}/volmain.c
	${CCRULE}
volprocs.o: ${VOLSER}/volprocs.c
	${CCRULE}
physio.o: ${VOLSER}/physio.c
	${CCRULE}
voltrans.o: ${VOLSER}/voltrans.c
	${CCRULE}
volerr.o: ${VOLSER}/volerr.c
	${CCRULE}
volint.cs.o: ${VOLSER}/volint.cs.c
	${CCRULE}
dumpstuff.o: ${VOLSER}/dumpstuff.c
	${CCRULE}
volint.ss.o: ${VOLSER}/volint.ss.c
	${CCRULE}
volint.xdr.o: ${VOLSER}/volint.xdr.c
	${CCRULE}

assert.o: ${UTIL}/assert.c
	${CCRULE}

uuid.o: ${UTIL}/uuid.c
	${CCRULE}

serverLog.o: ${UTIL}/serverLog.c
	${CCRULE}

fileutil.o: ${UTIL}/fileutil.c
	${CCRULE}

volparse.o: ${UTIL}/volparse.c
	${CCRULE}

flipbase64.o: ${UTIL}/flipbase64.c
	${CCRULE}

netutils.o: ${UTIL}/netutils.c
	${CCRULE}

dirpath.o: ${UTIL}/dirpath.c
	${CCRULE}

softsig.o: ${UTIL}/softsig.c
	${CCRULE}

lock.o: ${LWP}/lock.c
	${CCRULE}

threadname.o: ${LWP}/threadname.c
	${CCRULE}

aclprocs.o: ${LIBACL}/aclprocs.c
	${CCRULE}

netprocs.o: ${LIBACL}/netprocs.c
	${CCRULE}

# XXX we're having strange interactions with pruclient killer; disable trace for now
vldbint.cs.o: ${VLSERVER}/vldbint.cs.c
	${CCRULE} -DOSI_TRACEPOINT_DISABLE

vldbint.xdr.o: ${VLSERVER}/vldbint.xdr.c
	${CCRULE} -DOSI_TRACEPOINT_DISABLE

buffer.o: ${DIR}/buffer.c
	${CCRULE}

dir.o: ${DIR}/dir.c
	${CCRULE}

salvage.o: ${DIR}/salvage.c
	${CCRULE}

vnode.o: ${VOL}/vnode.c
	${CCRULE}

volume.o: ${VOL}/volume.c
	${CCRULE}

vutil.o: ${VOL}/vutil.c
	${CCRULE}

partition.o: ${VOL}/partition.c
	${CCRULE}

nuke.o: ${VOL}/nuke.c
	${CCRULE}

fssync-client.o: ${VOL}/fssync-client.c
	${CCRULE}

salvsync-client.o: ${VOL}/salvsync-client.c
	${CCRULE}

daemon_com.o: ${VOL}/daemon_com.c
	${CCRULE}

purge.o: ${VOL}/purge.c
	${CCRULE}

clone.o: ${VOL}/clone.c
	${CCRULE}

devname.o: ${VOL}/devname.c
	${CCRULE}

common.o: ${VOL}/common.c
	${CCRULE}

vscommon.o: ${VOLSER}/common.c
	${CCRULE}

listinodes.o: ${VOL}/listinodes.c
	${CCRULE}

ihandle.o: ${VOL}/ihandle.c
	${CCRULE}

vol_tracepoint_table.o: ${VOL}/tracepoint_table.c
	${CCRULE}

namei_ops.o: ${VOL}/namei_ops.c
	${CCRULE}

afsaux.o: ${FSINT}/afsaux.c
	${CCRULE}

afscbint.cs.o: ${FSINT}/afscbint.cs.c
	${CCRULE}

afscbint.ss.o: ${FSINT}/afscbint.ss.c
	${CCRULE}

afsint.cs.o: ${FSINT}/afsint.cs.c
	${CCRULE}

afsint.ss.o: ${FSINT}/afsint.ss.c
	${CCRULE}

afsint.xdr.o: ${FSINT}/afsint.xdr.c
	${CCRULE}

volserver: ${objects} ${LIBS}
	${CC} ${LDFLAGS} -o volserver ${objects} ${LIBS} ${MT_LIBS} ${XLIBS}

install: volserver
	${INSTALL} -d ${DESTDIR}${afssrvlibexecdir}
	${INSTALL_PROGRAM} volserver ${DESTDIR}${afssrvlibexecdir}/volserver

dest: volserver
	${INSTALL} -d ${DEST}/root.server/usr/afs/bin
	${INSTALL_PROGRAM} volserver ${DEST}/root.server/usr/afs/bin/volserver

clean:
	$(RM) -f *.o volserver core AFS_component_version_number.c

include ../config/Makefile.version

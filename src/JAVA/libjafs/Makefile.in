# Copyright 2000, International Business Machines Corporation and others.
# All Rights Reserved.
# 
# This software has been released under the terms of the IBM Public
# License.  For details, see the LICENSE file in the top-level source
# directory or online at http://www.openafs.org/dl/license10.html

include ../../config/Makefile.config
#${SYS_NAME}

DEST=@DEST@
@ENABLE_JAVA@JAVA_HOME=@JAVA_LIVES_HERE@
TOP_SRCDIR=@TOP_SRCDIR@
TOP_INCDIR=@TOP_INCDIR@
TOP_LIBDIR=@TOP_LIBDIR@
TOP_JLIBDIR=@TOP_SRCDIR@/JAVA/libjafs
JNI_INC=${JAVA_HOME}/include
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
libexecdir=@libexecdir@
libdir=@libdir@
includedir=@includedir@
mandir=@mandir@
afssrvbindir=@afssrvbindir@
afssrvsbindir=@afssrvsbindir@
afssrvlibexecdir=@afssrvlibexecdir@
COMPILE_ET=${TOP_SRCDIR}/comerr/compile_et
RXGEN=${TOP_SRCDIR}/rxgen/rxgen
SYS_NAME=@AFS_SYSNAME@
KRB5LIBS=@KRB5LIBS@


CC = ${MT_CC}
SHARED_FLAGS = -shared -Xlinker -Bsymbolic
OBJECT_FLAGS = -fPIC -c

ifeq "$(BUILD_TYPE)" "admin"
	INC := -I${TOP_INCDIR} -I${TOP_INCDIR}/afs/ -I${JAVA_HOME}/include -I ${JNI_INC} -I ${JNI_INC}/linux
	CFLAGS := ${INC} ${DBG} ${OPTMZ} -I${TOP_SRCDIR}/config ${MT_CFLAGS}
else
	INC := -I${TOP_SRCDIR}/libuafs -I${TOP_INCDIR} -I${JAVA_HOME}/include -I ${JNI_INC} -I ${JNI_INC}/linux
	CFLAGS := ${INC} ${DBG} ${OPTMZ} ${FSINCLUDES} -D_REENTRANT -DLIBJUAFS ${MT_CFLAGS}
endif


LIBJAFSADMDIR = a/
LIBJAFSDIR=j/
ROOTPACKAGEDIR = ../classes
RELPACKAGEDIR = org/openafs/jafs/
PACKAGEDIR = ${ROOTPACKAGEDIR}/${RELPACKAGEDIR}
JAVADOCSDIR = javadocs/

JAVAH = ${JAVA_HOME}/bin/javah -classpath ${ROOTPACKAGEDIR} -jni -d .
JAVAC = ${JAVA_HOME}/bin/javac -classpath ${ROOTPACKAGEDIR}

J_NATIVE_PREFIX = org.openafs.jafs.
C_NATIVE_PREFIX = org_openafs_jafs_

PACKAGE =\
	${PACKAGEDIR}ACL.class \
	${PACKAGEDIR}AFSException.class \
	${PACKAGEDIR}AFSFileException.class \
	${PACKAGEDIR}AFSSecurityException.class \
	${PACKAGEDIR}Cell.class \
	${PACKAGEDIR}File.class \
	${PACKAGEDIR}FileInputStream.class \
	${PACKAGEDIR}FileOutputStream.class \
	${PACKAGEDIR}Group.class \
	${PACKAGEDIR}Key.class \
	${PACKAGEDIR}Partition.class \
	${PACKAGEDIR}Process.class \
	${PACKAGEDIR}Server.class \
	${PACKAGEDIR}Token.class \
	${PACKAGEDIR}User.class \
	${PACKAGEDIR}Volume.class \
	${PACKAGEDIR}VersionInfo.class

ifeq (${SYS_NAME}, ppc64_linux26)
LIBJAFS_OBJS =
else
ifeq (${SYS_NAME}, s390x_linux26)
LIBJAFS_OBJS =
else
LIBJAFS_OBJS =\
        ${LIBJAFSDIR}GetNativeString.o \
        ${LIBJAFSDIR}ACL.o
endif
endif

LIBJAFS_OBJS +=\
	${LIBJAFSDIR}File.o \
	${LIBJAFSDIR}FileInputStream.o \
	${LIBJAFSDIR}FileOutputStream.o \
	${LIBJAFSDIR}Internal.o \
	${LIBJAFSDIR}UserToken.o \
	${LIBJAFSDIR}VersionInfo.o \
	${LIBJAFSDIR}AFS_component_version_number.o \
        ${TOP_SRCDIR}/util/rxkstats.o

ifeq (${SYS_NAME}, ppc64_linux26)
LIBJAFSADM_OBJS =\
        ${LIBJAFSADMDIR}GetNativeString.o \
        ${LIBJAFSADMDIR}ACL.o
else
ifeq (${SYS_NAME}, s390x_linux26)
LIBJAFSADM_OBJS =\
        ${LIBJAFSADMDIR}GetNativeString.o \
        ${LIBJAFSADMDIR}ACL.o
else
LIBJAFSADM_OBJS =
endif
endif

LIBJAFSADM_OBJS +=\
	${LIBJAFSADMDIR}AdminToken.o \
	${LIBJAFSADMDIR}Cell.o \
	${LIBJAFSADMDIR}Group.o \
	${LIBJAFSADMDIR}Internal.o \
	${LIBJAFSADMDIR}Key.o \
	${LIBJAFSADMDIR}Partition.o \
	${LIBJAFSADMDIR}Process.o \
	${LIBJAFSADMDIR}Server.o \
	${LIBJAFSADMDIR}User.o \
	${LIBJAFSADMDIR}Version2.o \
	${LIBJAFSADMDIR}AFS_component_version_number.o \
	${LIBJAFSADMDIR}Volume.o

CORRELATING_SOURCE_FILES =\
	${LIBJAFSADMDIR}ACL.c \
	${LIBJAFSADMDIR}Cell.c \
	${LIBJAFSADMDIR}File.c \
	${LIBJAFSADMDIR}FileInputStream.c \
	${LIBJAFSADMDIR}FileOutputStream.c \
	${LIBJAFSADMDIR}Group.c \
	${LIBJAFSADMDIR}Key.c \
	${LIBJAFSADMDIR}Partition.c \
	${LIBJAFSADMDIR}Process.c \
	${LIBJAFSADMDIR}Server.c \
	${LIBJAFSADMDIR}User.c \
	${LIBJAFSADMDIR}Volume.c \
	${LIBJAFSADMDIR}VersionInfo.c


JAVA_HEADERS = ${PACKAGE:${PACKAGEDIR}%.class=${C_NATIVE_PREFIX}%.h}

BOSADMINLIB = ${TOP_LIBDIR}/libbosadmin.a
VOSADMINLIB = ${TOP_LIBDIR}/libvosadmin.a
PTSADMINLIB = ${TOP_LIBDIR}/libptsadmin.a
KASADMINLIB = ${TOP_LIBDIR}/libkasadmin.a
CFGADMINLIB = ${TOP_LIBDIR}/libcfgadmin.a
UTILADMINLIB = ${TOP_LIBDIR}/libafsadminutil.a
CLIENTADMINLIB = ${TOP_LIBDIR}/libclientadmin.a

LIBJAFS_LIBS =\
	${TOP_LIBDIR}/libjuafs.a \
	${TOP_LIBDIR}/libdes.a \
	${KRB5LIBS} \
	-lresolv \
	-lpthread

@ENABLE_PIC_LIBS@PIC_SUFFIX=_pic

LIBJAFSADM_LIBS =\
	${CLIENTADMINLIB} \
	${VOSADMINLIB} \
	${BOSADMINLIB} \
	${PTSADMINLIB} \
	${KASADMINLIB} \
	${CFGADMINLIB} \
	${UTILADMINLIB} \
	${TOP_LIBDIR}/libafsauthent$(PIC_SUFFIX).a \
	${TOP_LIBDIR}/libafsrpc$(PIC_SUFFIX).a \
	${TOP_LIBDIR}/libcmd.a \
	${TOP_LIBDIR}/util.a \
	${KRB5LIBS} \
	-lresolv \
	-lpthread


JARFILE = jafs.jar

all:  ${TOP_JLIBDIR} libjafs libjafsadm ${PACKAGE} all_jar

install:  all ${DESTDIR}${libdir}/libjafs.so ${DESTDIR}${libdir}/libjafsadm.so ${PACKAGE} install_jar
	if [ ! -e /usr/afswsp ]; then \
	  mkdir -p /usr/afswsp/; \
	fi; \
	if [ ! -e /usr/afswsp/etc ]; then \
	  mkdir -p /usr/afswsp/etc/; \
	  cp ./etc/CacheConfig /usr/afswsp/etc/; \
	fi; \
	if [ ! -e /usr/afswsp/log ]; then \
	  mkdir -p /usr/afswsp/log/; \
	fi; \
	if [ ! -e /usr/afswsp/cache ]; then \
	  mkdir -p /usr/afswsp/cache/; \
	fi; \
	if [ ! -L /usr/vice/etc/CellServDB ]; then \
	  ln -s /usr/vice/etc/CellServDB /usr/afswsp/etc/; \
	fi; \
	if [ ! -L /usr/vice/etc/ThisCell ]; then \
	  ln -s /usr/vice/etc/ThisCell /usr/afswsp/etc/; \
	fi

clean:
	${RM} -f ${PACKAGEDIR}*.class ${LIBJAFSADMDIR}*.o ${LIBJAFSDIR}*.o ${C_NATIVE_PREFIX}*.h

setup:	FORCE
	test -e a -a -e j || mkdir a j
	if [ ! -e ./h ]; then \
	  ln -s /usr/include/sys h; \
	fi; \

${TOP_JLIBDIR}:
	mkdir -p $@

FORCE: ;

############# Shared library ###############################

libjafs: setup
	export BUILD_TYPE=user; \
	${MAKE} ${TOP_LIBDIR}/libjafs.so

libjafsadm:
	export BUILD_TYPE=admin; \
	${MAKE} ${TOP_LIBDIR}/libjafsadm.so

${TOP_LIBDIR}/libjafs.so: ${LIBJAFS_OBJS}
	${CC} ${CFLAGS} ${SHARED_FLAGS} -o $@ $^ ${LIBJAFS_LIBS}

${DESTDIR}${libdir}/libjafs.so: ${LIBJAFS_OBJS}
	${CC} ${CFLAGS} ${SHARED_FLAGS} -o $@ $^ ${LIBJAFS_LIBS}

${TOP_LIBDIR}/libjafsadm.so: ${LIBJAFSADM_OBJS}
	${CC} ${CFLAGS} ${SHARED_FLAGS} -o $@ $^ ${LIBJAFSADM_LIBS}

${DESTDIR}${libdir}/libjafsadm.so: ${LIBJAFSADM_OBJS}
	${CC} ${CFLAGS} ${SHARED_FLAGS} -o $@ $^ ${LIBJAFSADM_LIBS}

############## Object files ################################

#${LIBJAFSADM_OBJS}: %.o: %.c
#	${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<

${LIBJAFSDIR}ACL.o: ACL.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}File.o: File.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}FileInputStream.o: FileInputStream.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}FileOutputStream.o: FileOutputStream.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}GetNativeString.o: GetNativeString.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}Internal.o: Internal.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}UserToken.o: UserToken.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}VersionInfo.o: VersionInfo.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSDIR}AFS_component_version_number.o: AFS_component_version_number.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<

${LIBJAFSADMDIR}ACL.o: ACL.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}AdminToken.o: AdminToken.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Cell.o: Cell.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}GetNativeString.o: GetNativeString.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Group.o: Group.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Internal.o: Internal.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Key.o: Key.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Partition.o: Partition.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Process.o: Process.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Server.o: Server.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}User.o: User.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Version2.o: Version2.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}Volume.o: Volume.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<
${LIBJAFSADMDIR}AFS_component_version_number.o: AFS_component_version_number.c; ${CC} ${CFLAGS} ${OBJECT_FLAGS} -o $@ $<

############## C files #####################################

${CORRELATING_SOURCE_FILES}: %.c: ${C_NATIVE_PREFIX}%.h Internal.h
${LIBJAFSDIR}ACL.o: ${C_NATIVE_PREFIX}ACL.h
${LIBJAFSDIR}File.o: ${C_NATIVE_PREFIX}File.h
${LIBJAFSDIR}FileInputStream.o: ${C_NATIVE_PREFIX}FileInputStream.h
${LIBJAFSDIR}FileOutputStream.o: ${C_NATIVE_PREFIX}FileOutputStream.h
${LIBJAFSDIR}VersionInfo.o: ${C_NATIVE_PREFIX}VersionInfo.h
${LIBJAFSADMDIR}ACL.o: ${C_NATIVE_PREFIX}ACL.h
${LIBJAFSADMDIR}Cell.o: ${C_NATIVE_PREFIX}Cell.h
${LIBJAFSADMDIR}Group.o: ${C_NATIVE_PREFIX}Group.h
${LIBJAFSADMDIR}Key.o: ${C_NATIVE_PREFIX}Key.h
${LIBJAFSADMDIR}Partition.o: ${C_NATIVE_PREFIX}Partition.h
${LIBJAFSADMDIR}Process.o: ${C_NATIVE_PREFIX}Process.h
${LIBJAFSADMDIR}Server.o: ${C_NATIVE_PREFIX}Server.h
${LIBJAFSADMDIR}User.o: ${C_NATIVE_PREFIX}User.h
${LIBJAFSADMDIR}Volume.o: ${C_NATIVE_PREFIX}Volume.h

AdminToken.c: ${C_NATIVE_PREFIX}Token.h ${C_NATIVE_PREFIX}Cell.h

Internal.c: Internal.h

Version2.c: ${C_NATIVE_PREFIX}VersionInfo.h JAFS_Version.h

UserToken.c: ${C_NATIVE_PREFIX}Token.h

############## Package javac section #########################

${PACKAGEDIR}%.class: ${PACKAGEDIR}%.java
	${JAVAC} $<

############## Javah section ###############################

${JAVA_HEADERS}: ${C_NATIVE_PREFIX}%.h: ${PACKAGEDIR}%.class
	${JAVAH} ${J_NATIVE_PREFIX}$*

############# JAR file #####################################

all_jar: clean_jar
	cd ${ROOTPACKAGEDIR}; ${JAVA_HOME}/bin/jar -cMf ${TOP_JLIBDIR}/${JARFILE} *.properties ${RELPACKAGEDIR}*.class

install_jar: clean_jar
	cd ${ROOTPACKAGEDIR}; ${JAVA_HOME}/bin/jar -cMf ${JAVA_HOME}/lib/${JARFILE} *.properties ${RELPACKAGEDIR}*.class

clean_jar:
	${RM} -f ${TOP_JLIBDIR}/${JARFILE}

include ../../config/Makefile.version
